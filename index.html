<html>
  <head>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <!--Load the AJAX API-->
    <script type="text/javascript">
      var dataGlobal;
      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(getData);


      function getData(){
        $.get( "http://jfteledev.azurewebsites.net/api/Sensors/", function( data ) {
          dataGlobal = data;
          var arraySensor1 = [];
          var arrayFechas = [];
          var arraySensor2 = [];
          for(var i=0;i<data.length;i++){
            arraySensor1.push(data[i].valor1);
            arraySensor2.push(data[i].valor2);
            arrayFechas.push(data[i].fecha1);

          }
          console.log(data.length);
          var dataChart = new google.visualization.DataTable();
          drawChart(dataChart, arraySensor1, arraySensor2, arrayFechas);
          addNewDataInChart(dataChart);

        });
      }

      function drawChart(dataChart, arr1, arr2, arrDate) {

        // Create the dataChart table.

        dataChart.addColumn('string', 'fecha');
        dataChart.addColumn('number', 'SpO2');
        dataChart.addColumn('number', 'Pulse');
        for(var i=0;i<arr1.length;i++){
          dataChart.addRows([[arrDate[i].toString(), arr1[i],arr2[i]]]);
        }

        // Set chart options
        var options = {'title':'Paciente 201, datos del pulsoximetro', 'width':700, 'height':300};

        // Instantiate and draw our chart, passing in some options.
        var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
        chart.draw(dataChart, options);
        addNewDataInChart(dataChart, chart);

      }
      function addNewDataInChart(dataChart, andChart){
        setTimeout(function () {    //  call a 3s setTimeout when the loop is called
          $.get( "http://jfteledev.azurewebsites.net/api/Sensors/", function( data ) {
            console.log("Iterator");
            var lastData = data[data.length - 1];
            var lastFecha = lastData.fecha1;
            var val1 = lastData.valor1;
            var val2 = lastData.valor2;
            var fecha = lastData.fecha1;

            dataChart.addRows([[fecha.toString(), val1, val2]]);

            var options = {'title':'Paciente 201, datos del pulsoximetro', 'width':700, 'height':300};

            andChart.draw(dataChart, options);
            lastFecha = fecha;
            
            addNewDataInChart(dataChart, andChart);
          });
        }, 1000)
       }


    </script>
  </head>

  <body>
    <!--Div that will hold the pie chart-->
    <div id="chart_div"></div>
  </body>
</html>
